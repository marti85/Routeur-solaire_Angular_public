<div class="container-fluid">
  <h1 class="h3 mb-4 text-gray-800">Tableau de Bord</h1>

  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    {{ errorMessage }}
  </div>

  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Sélectionner un Routeur et une Période</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="routeurSelect" class="form-label">Choisissez un routeur :</label>
          <select class="form-select" id="routeurSelect"
                  [(ngModel)]="selectedRouteurId"
                  (change)="onSelectionChange()">
            <option [ngValue]="null" disabled>-- Sélectionnez un routeur --</option>
            <option *ngFor="let routeur of routeurs" [ngValue]="routeur.id">
              {{ routeur.nom }} ({{ routeur.identifiant }})
            </option>
          </select>
          <div *ngIf="routeurs.length === 0 && !errorMessage" class="text-muted mt-2">
            Aucun routeur disponible. Veuillez ajouter des routeurs.
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label for="dateSelect" class="form-label">Sélectionner une date :</label>
          <input type="date" class="form-control" id="dateSelect"
                 [(ngModel)]="selectedDate"
                 (change)="onSelectionChange()">
        </div>

        <div class="col-md-4 mb-3">
          <label for="periodSelect" class="form-label">Afficher par :</label>
          <select class="form-select" id="periodSelect"
                  [(ngModel)]="selectedPeriod"
                  (change)="onSelectionChange()">
            <option value="day">Jour</option>
            <option value="week">Semaine</option> <!-- AJOUT -->
            <option value="month">Mois</option>
            <option value="year">Année</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="selectedRouteurId && mesures.length > 0" class="card shadow mb-4 mt-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Mesures pour le routeur sélectionné</h6>
    </div>
    <div class="card-body">
      <div class="chart-container" style="position: relative; height:40vh; width:80vw">
        <canvas id="mesuresChart"></canvas>
      </div>

      <h5 class="mt-4">Détails des dernières mesures:</h5>
      <ul class="list-group">
        <li class="list-group-item" *ngFor="let mesure of mesures | slice:0:10">
          <div *ngIf="selectedPeriod === 'day'">
            Puissance: {{ mesure.puissance_solaire }} W - Temps: {{ mesure.timestamp | date:'medium' }}
          </div>
          <div *ngIf="selectedPeriod !== 'day'">
            Moyenne solaire: {{ mesure.puissance_solaire_moyenne }} W |
            Moyenne soutirée: {{ mesure.puissance_soutiree_moyenne }} W |
            Triac: {{ mesure.ouverture_triac_moyenne }} % - 
            Date: {{ mesure.timestamp | date:'mediumDate' }}
          </div>
        </li>
      </ul>
    </div>
  </div>

  <div *ngIf="selectedRouteurId && mesures.length === 0 && !errorMessage" class="card shadow mb-4 mt-4">
    <div class="card-body">
      <p class="text-center text-muted">Aucune mesure disponible pour ce routeur avec la date et la période sélectionnées.</p>
    </div>
  </div>

  <div *ngIf="!selectedRouteurId && routeurs.length > 0" class="card shadow mb-4 mt-4">
    <div class="card-body">
      <p class="text-center text-muted">Veuillez sélectionner un routeur pour voir ses mesures.</p>
    </div>
  </div>
</div>
